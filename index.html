<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <!-- CORRE칂츾O: Link completo do SDK do Owlbear -->
    <script src="https://unpkg.com"></script>
</head>
<body style="background: #242424; color: white; font-family: sans-serif; text-align: center; padding: 20px; overflow: hidden;">
    <h3 style="color: #bb86fc;">游꿠 Persona FX Ativo</h3>
    <p style="font-size: 14px;">Tokens na camada CHARACTER agora respiram e inclinam ao mover.</p>

    <script>
        const OBR = window.OBR;
        let posicoesAnteriores = {};

        OBR.onReady(() => {
            console.log("Extens칚o Persona iniciada com sucesso!");

            // --- 1. L칍GICA DE MOVIMENTO (TILT) ---
            OBR.scene.items.onChange(async (items) => {
                const characters = items.filter(i => i.layer === "CHARACTER");
                const updates = [];

                for (const item of characters) {
                    const posAntiga = posicoesAnteriores[item.id];
                    
                    // Se a posi칞칚o mudou no eixo X ou Y
                    if (posAntiga && (posAntiga.x !== item.position.x || posAntiga.y !== item.position.y)) {
                        const direcao = item.position.x > posAntiga.x ? 1 : -1;
                        const anguloAlvo = direcao * 15;

                        // S칩 atualiza se o 칙ngulo for diferente (evita loops infinitos)
                        if (item.rotation !== anguloAlvo) {
                            updates.push({ id: item.id, rotation: anguloAlvo });
                        }
                    }
                    // Salva a posi칞칚o atual para a pr칩xima compara칞칚o
                    posicoesAnteriores[item.id] = { x: item.position.x, y: item.position.y };
                }

                if (updates.length > 0) {
                    await OBR.scene.items.updateItems(updates.map(u => u.id), (items) => {
                        for (let i of items) {
                            const up = updates.find(u => u.id === i.id);
                            i.rotation = up.rotation;
                        }
                    });

                    // Efeito Mola: Volta ao zero ap칩s 400ms
                    setTimeout(async () => {
                        await OBR.scene.items.updateItems(updates.map(u => u.id), (items) => {
                            for (let i of items) i.rotation = 0;
                        });
                    }, 400);
                }
            });

            // --- 2. L칍GICA DE RESPIRA칂츾O (LOOP) ---
            setInterval(async () => {
                const items = await OBR.scene.items.getItems(i => i.layer === "CHARACTER");
                if (items.length === 0) return;

                await OBR.scene.items.updateItems(items.map(i => i.id), (tokens) => {
                    for (let token of tokens) {
                        // Alterna entre 1.0 e 1.03 (Efeito Persona sutil)
                        const novaEscala = token.scale.x === 1 ? 1.03 : 1;
                        token.scale = { x: novaEscala, y: novaEscala };
                    }
                });
            }, 2500); // 2.5 segundos para ser leve na rede
        });
    </script>
</body>
</html>
